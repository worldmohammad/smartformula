<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCut Pro | Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÙ„ÛŒØ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.default.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; }
        .card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0; }
        .btn-primary { background-color: #0f172a; color: white; padding: 0.6rem 1.2rem; border-radius: 0.375rem; transition: all 0.2s; font-size: 0.9rem; }
        .btn-primary:hover { background-color: #1e293b; }
        .btn-danger { background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; }
        .btn-success { background-color: #10b981; color: white; padding: 0.6rem 1.2rem; border-radius: 0.375rem; transition: all 0.2s; font-size: 0.9rem; }
        .btn-success:hover { background-color: #059669; }
        .input-style { border: 1px solid #cbd5e1; padding: 0.6rem; border-radius: 0.375rem; width: 100%; font-size: 0.9rem; transition: border-color 0.2s; background-color: #f8fafc; }
        .input-style:focus { border-color: #0f172a; outline: none; background-color: #fff; }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2; }
        .tab-btn { padding: 0.75rem 1.5rem; border-bottom: 2px solid transparent; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #0f172a; color: #0f172a; }
        .hidden-tab { display: none; }
        th { padding: 0.75rem; text-align: right; font-weight: 600; color: #475569; background-color: #f1f5f9; font-size: 0.85rem; }
        td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #f1f5f9; color: #334155; }
        @media print {
            body { background-color: white; padding: 0; }
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #000; margin: 0; padding: 10px; }
            #assignment-results { display: block !important; }
            #assignment-results table { font-size: 12px; width: 100%; border-collapse: collapse; }
            #assignment-results th, #assignment-results td { border: 1px solid black; padding: 5px; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            #justice-chart-container { display: none; }
        }
        .print-header { display: none; }
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ TomSelect Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¨Ø§ Ù‚Ø§Ù„Ø¨ */
.ts-control {
    border: 1px solid #cbd5e1 !important;
    border-radius: 0.375rem !important;
    padding: 0.6rem !important;
    background-color: #f8fafc !important;
    font-family: 'Vazirmatn', sans-serif !important;
    font-size: 0.9rem !important;
    text-align: right !important; /* Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† Ú©Ø±Ø¯Ù† Ù…ØªÙ† */
}
.ts-control:focus-within {
    border-color: #0f172a !important;
    background-color: #fff !important;
}
.ts-dropdown {
    border-radius: 0.5rem !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
    text-align: right !important; /* Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª */
    font-family: 'Vazirmatn', sans-serif !important;
    z-index: 50 !important;
}
.ts-dropdown .option {
    padding: 8px 12px !important;
}
.ts-dropdown .active {
    background-color: #f1f5f9 !important;
    color: #0f172a !important;
}
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 no-print border-b border-slate-200 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 mb-1">SmartCut Pro</h1>
                <p class="text-xs text-slate-500">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®Ø· Ø¨Ø±Ø´</p>
            </div>
            <div class="flex space-x-reverse space-x-6 mt-4 md:mt-0">
                <button id="tab-btn-dashboard" class="tab-btn active" onclick="switchTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</button>
                <button id="tab-btn-settings" class="tab-btn" onclick="switchTab('settings')">ØªØ¹Ø§Ø±ÛŒÙ Ù¾Ø§ÛŒÙ‡</button>
                <button id="tab-btn-history" class="tab-btn" onclick="switchTab('history')">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¹Ù…Ù„Ú©Ø±Ø¯</button>
            </div>
        </div>

        <div class="print-header">
            <h2 class="text-2xl font-bold">Ø­ÙˆØ§Ù„Ù‡ Ø¨Ø±Ø´ / Work Order</h2>
            <p id="print-date" class="text-sm mt-2"></p>
        </div>

        <div id="tab-dashboard">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-2 space-y-6 no-print">
                    
                    <div class="card relative">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <h3 class="font-bold text-slate-800">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</h3>
                            <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø±</span>
                        </div>
                        
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-2">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÛŒØ¹ Ù…Ø­ØµÙˆÙ„</label>
                                <select id="quick-product-select" class="input-style" onchange="applyProductTemplate()">
                                    <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-2">Ú©Ø¯ Ø¨Ø±Ø´ (Cut Code)</label>
                                <input type="text" id="task-cut-code" class="input-style" placeholder="Ù…Ø«Ø§Ù„: A-101">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
                            <div class="col-span-2">
                                <label class="text-xs text-slate-500 block mb-1">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ <span class="text-red-500">*</span></label>
                                <input type="text" id="task-product" class="input-style" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù„ÙˆØ§Ø±">
                            </div>
                            <div class="col-span-1">
                                <label class="text-xs text-slate-500 block mb-1">Ø³Ø§ÛŒØ² <span class="text-red-500">*</span></label>
                                <input type="text" id="task-size" class="input-style" placeholder="0">
                            </div>
                            <div class="col-span-1">
                                <label class="text-xs text-slate-500 block mb-1">ØªØ¹Ø¯Ø§Ø¯ Ø³Ø±ÛŒ <span class="text-red-500">*</span></label>
                                <input type="number" id="task-series-count" class="input-style" min="0.5" step="0.5" placeholder="2">
                            </div>
                            <div class="col-span-1">
                                <label class="text-xs text-slate-500 block mb-1">Ø¹Ø¯Ø¯ Ø¯Ø± Ø³Ø±ÛŒ <span class="text-red-500">*</span></label>
                                <input type="number" id="task-items-per-series" class="input-style" min="1" placeholder="100">
                            </div>
                            <div class="col-span-1">
                                <label class="text-xs text-slate-700 block mb-1 font-bold">Ø²Ù…Ø§Ù† ÙˆØ§Ø­Ø¯ (Ø«Ø§Ù†ÛŒÙ‡) <span class="text-red-500">*</span></label>
                                <input type="number" id="task-std-time" class="input-style bg-slate-50 border-slate-300" min="1" step="1">
                            </div>
                            <input type="hidden" id="task-lines" value="0">
                            
                            <div class="col-span-2 md:col-span-6 flex flex-wrap justify-between items-center bg-slate-50 p-3 rounded border border-slate-200 mt-2 gap-2">
                                <div class="flex gap-6 text-sm">
                                    <span>Ù…Ø¯Ù„: <strong id="display-design" class="text-slate-800">-</strong></span>
                                    <span class="text-slate-300">|</span>
                                    <span>ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·: <strong id="display-lines" class="text-slate-800">-</strong></span>
                                </div>
                                <button id="add-task-btn" class="btn-primary h-[38px] px-6">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª</button>
                            </div>
                        </div>

                        <div id="current-tasks-container" class="mt-8 hidden">
                            <h4 class="font-bold text-sm text-slate-700 mb-3">Ù„ÛŒØ³Øª Ø§Ù‚Ù„Ø§Ù… Ø¬Ø§Ø±ÛŒ</h4>
                            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th>Ú©Ø¯ Ø¨Ø±Ø´</th><th>Ù…Ø­ØµÙˆÙ„</th><th>Ø³Ø§ÛŒØ²</th><th class="text-center">Ø³Ø±ÛŒ</th><th class="text-center">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„</th><th class="text-center">Ø²Ù…Ø§Ù† Ú©Ù„ (Ø¯Ù‚ÛŒÙ‚Ù‡)</th><th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="current-tasks-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card text-center border-dashed border-2 border-slate-300 bg-slate-50 hover:bg-white transition-colors">
                        <h3 class="font-bold text-slate-900 mb-2">Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹</h3>
                        <p class="text-sm text-slate-500 mb-4">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡ ØªÙˆØ²ÛŒØ¹ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¸Ø±ÙÛŒØª Ùˆ Ù…Ù‡Ø§Ø±Øª</p>
                        <button id="distribute-btn" class="btn-primary bg-indigo-600 hover:bg-indigo-700 w-full md:w-1/2 text-lg py-3 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                        </button>
                    </div>
                </div>

                <div id="assignment-results" class="lg:col-span-3 hidden">
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-slate-900 text-white p-4 font-bold flex justify-between items-center no-print">
                            <span>Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ ØªØ®ØµÛŒØµ (Work Order)</span>
                            <div class="flex items-center gap-3">
                                <span id="today-total-time" class="text-sm bg-slate-700 px-3 py-1 rounded"></span>
                                <button onclick="window.print()" class="bg-white text-slate-900 px-4 py-1.5 rounded text-sm hover:bg-slate-100 font-medium transition">Ú†Ø§Ù¾ Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Ù¾Ø±Ø³Ù†Ù„ / Ø³Ø·Ø­ Ù…Ù‡Ø§Ø±Øª</th>
                                        <th>Ø´Ø±Ø­ Ø¹Ù…Ù„ÛŒØ§Øª (Ù…Ø­ØµÙˆÙ„ / Ø³Ø§ÛŒØ² / Ø³Ø±ÛŒ)</th>
                                        <th class="text-center">Ú©Ø¯ Ø¨Ø±Ø´</th>
                                        <th class="text-center">ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÙ„ÛŒØ¯</th>
                                        <th class="text-center">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·</th>
                                        <th class="text-center">Ø²Ù…Ø§Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (Ø¯Ù‚ÛŒÙ‚Ù‡)</th>
                                    </tr>
                                </thead>
                                <tbody id="assignment-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 lg:row-start-1 lg:col-start-3 no-print">
                    <div class="card h-full sticky top-4">
                        <div class="flex justify-between items-center border-b border-slate-100 pb-3 mb-4">
                            <h3 class="font-bold text-slate-800">ÙˆØ¶Ø¹ÛŒØª Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ</h3>
                            <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Active</span>
                        </div>
                        
                        <div id="worker-list-container" class="space-y-3 max-h-[450px] overflow-y-auto pr-1 mb-6 scrollbar-thin">
                            <p class="text-slate-400 text-sm text-center py-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                        </div>

                        <div id="justice-chart-container" class="border-t border-slate-100 pt-6">
                            <h3 class="font-bold text-slate-800 text-sm mb-4 text-center">ØªÙˆØ²ÛŒØ¹ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
                            <div class="w-full h-48 relative">
                                <canvas id="justiceChart"></canvas>
                            </div>
                            <p class="text-[10px] text-slate-400 text-center mt-4">ØªÙˆØ²ÛŒØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ø§Ù†Ø¯Ù…Ø§Ù† Ùˆ Ø³Ø·Ø­ Ù…Ù‡Ø§Ø±Øª</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="tab-settings" class="hidden-tab">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <input type="text" id="tpl-group" placeholder="Ú¯Ø±ÙˆÙ‡ Ù…Ø­ØµÙˆÙ„" class="input-style md:col-span-2" onkeypress="handleEnter(event, 'addProductTemplate')">
                        <input type="text" id="tpl-product-name" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" class="input-style md:col-span-2" onkeypress="handleEnter(event, 'addProductTemplate')">
                        <input type="text" id="tpl-design" placeholder="Ø·Ø±Ø­/Ù…Ø¯Ù„" class="input-style md:col-span-2" onkeypress="handleEnter(event, 'addProductTemplate')">
                        
                        <input type="number" id="tpl-lines" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·" class="input-style md:col-span-3" onkeypress="handleEnter(event, 'addProductTemplate')">
                        <input type="number" id="tpl-std-time" placeholder="Ø²Ù…Ø§Ù† ÙˆØ§Ø­Ø¯ (Ø«Ø§Ù†ÛŒÙ‡)" class="input-style md:col-span-3" step="1" onkeypress="handleEnter(event, 'addProductTemplate')">
                        
                        <button onclick="addProductTemplate()" class="btn-primary md:col-span-6 mt-2">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¨Ø§Ù†Ú© Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ</button>
                    </div>
                    
                    <div class="overflow-x-auto max-h-[400px] border rounded-lg">
                        <table class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Ú¯Ø±ÙˆÙ‡</th>
                                    <th>Ù…Ø­ØµÙˆÙ„</th>
                                    <th>Ù…Ø¯Ù„</th>
                                    <th class="text-center">Ø®Ø·</th>
                                    <th class="text-center">Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="product-templates-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±Ø³Ù†Ù„</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <input type="text" id="worker-name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" class="input-style col-span-2" onkeypress="handleEnter(event, 'addWorker')">
                        <select id="worker-level" class="input-style"><option value="Ù‚ÙˆÛŒ">Ù‚ÙˆÛŒ (Senior)</option><option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø· (Mid)</option><option value="Ø¶Ø¹ÛŒÙ">Ø¶Ø¹ÛŒÙ (Junior)</option></select>
                        <button id="add-worker-btn" class="btn-primary col-span-3 mt-2" onclick="addWorker()">Ø«Ø¨Øª Ù¾Ø±Ø³Ù†Ù„</button>
                    </div>
                    <div class="overflow-y-auto max-h-[300px] border rounded-lg"><table class="w-full text-sm"><tbody id="workers-management-body"></tbody></table></div>
                </div>

                <div class="card">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Backup/Restore)</h2>
                    <div class="flex flex-col gap-4">
                        <button onclick="exportData()" class="btn-primary w-full text-center bg-blue-600 hover:bg-blue-700">ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Backup)</button>
                        
                        <div class="border-t border-slate-100 pt-4">
                            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                            <button onclick="document.getElementById('import-file').click()" class="btn-primary w-full text-center bg-green-600 hover:bg-green-700">ğŸ“¤ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Restore)</button>
                             <p class="text-xs text-gray-400 mt-2 text-center">ÙØ§ÛŒÙ„ .json Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
                        </div>
                    </div>
                </div>
                
                 <div class="card border border-red-200 bg-red-50">
                    <h3 class="font-bold text-red-800 mb-2">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…</h3>
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-red-600">Ø­Ø°Ù ØªÙ…Ø§Ù…ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</p>
                        <button onclick="clearAllData()" class="btn-danger text-xs px-4 py-2">Reset Factory</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-history" class="hidden-tab">
            <div class="card">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                    <h2 class="text-xl font-bold text-slate-800">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ (History Log)</h2>
                </div>

                <div class="flex flex-col gap-4 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                             <label class="block text-xs text-slate-500 mb-1">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ†</label>
                            <input type="text" id="history-search-q" class="input-style" placeholder="Ù†Ø§Ù…ØŒ Ù…Ø­ØµÙˆÙ„ØŒ Ú©Ø¯ Ø¨Ø±Ø´..." oninput="renderHistory()">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Ù¾Ø±Ø³Ù†Ù„</label>
                            <select id="history-filter-worker" class="input-style" onchange="renderHistory()">
                                <option value="">Ù‡Ù…Ù‡ Ù¾Ø±Ø³Ù†Ù„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Ø§Ø² ØªØ§Ø±ÛŒØ® (Ù…Ø«Ù„Ø§ 1402/09/01)</label>
                            <input type="text" id="history-filter-date-from" class="input-style" placeholder="Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²Ù‡..." oninput="renderHistory()">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
                            <input type="text" id="history-filter-date-to" class="input-style" placeholder="Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²Ù‡..." oninput="renderHistory()">
                        </div>
                    </div>
                    <div class="flex justify-end border-t pt-3 mt-1 gap-2">
                        <button onclick="resetHistoryFilters()" class="btn-danger h-[38px] px-3 text-xs" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§">Ø±ÛŒØ³Øª ÙÛŒÙ„ØªØ±</button>
                        <button onclick="exportReportExcel()" class="btn-success h-[38px] flex items-center gap-2 text-sm px-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„
                        </button>
                    </div>
                </div>

                <div id="history-summary" class="hidden mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 border border-blue-200 rounded p-4 text-center">
                        <span class="text-xs text-slate-500 block mb-1">Ù…Ø¬Ù…ÙˆØ¹ ØªØ¹Ø¯Ø§Ø¯ (ØªÙˆÙ„ÛŒØ¯)</span>
                        <strong class="text-xl text-blue-700" id="summary-total-items">0</strong>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-200 rounded p-4 text-center">
                         <span class="text-xs text-slate-500 block mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø· (Ú©Ø§Ø±Ù…Ø²Ø¯)</span>
                        <strong class="text-xl text-indigo-700" id="summary-total-lines">0</strong>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded p-4 text-center">
                         <span class="text-xs text-slate-500 block mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)</span>
                        <strong class="text-xl text-green-700" id="summary-total-time">0</strong>
                    </div>
                </div>

                <div class="overflow-x-auto min-h-[400px] border rounded-lg">
                    <table class="w-full text-sm">
                        <thead>
                            <tr>
                                <th>ØªØ§Ø±ÛŒØ®</th>
                                <th>Ù¾Ø±Ø³Ù†Ù„</th>
                                <th class="text-center">Ú©Ø¯ Ø¨Ø±Ø´</th>
                                <th>Ù…Ø­ØµÙˆÙ„ / Ø³Ø§ÛŒØ²</th>
                                <th class="text-center">Ø³Ø±ÛŒ</th>
                                <th class="text-center">ØªØ¹Ø¯Ø§Ø¯</th>
                                <th class="text-center">Ø®Ø·</th>
                                <th class="text-center">Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)</th>
                                <th class="text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
                <div id="history-pagination" class="flex justify-center items-center gap-4 mt-6">
                    <button onclick="changeHistoryPage(-1)" class="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300 disabled:opacity-50" id="prev-page-btn">Ù‚Ø¨Ù„ÛŒ</button>
                    <span id="page-indicator" class="text-sm font-bold text-slate-600">ØµÙØ­Ù‡ 1</span>
                    <button onclick="changeHistoryPage(1)" class="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300 disabled:opacity-50" id="next-page-btn">Ø¨Ø¹Ø¯ÛŒ</button>
                </div>
                <p id="no-history-msg" class="text-center text-slate-400 py-12 hidden">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
            </div>
        </div>
    </div>

    <div id="preview-modal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4 z-50 no-print backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl max-w-5xl w-full shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="text-xl font-bold text-slate-800">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØ®ØµÛŒØµ Ú©Ø§Ø±</h3>
                <button onclick="closePreviewModal()" class="text-slate-400 hover:text-slate-600 transition text-2xl">&times;</button>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded-r text-sm text-blue-700">
                <p class="font-bold mb-1">Ø±Ø§Ù‡Ù†Ù…Ø§:</p>
                <p>Ø³ÛŒØ³ØªÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ØŒ Ú©Ø§Ø±Ù‡Ø§ Ø±Ø§ ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø³Ø¦ÙˆÙ„ Ù‡Ø± Ø±Ø¯ÛŒÙ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.</p>
            </div>

            <div class="overflow-y-auto flex-1 mb-6 border rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="p-3">Ø´Ø±Ø­ Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            <th class="p-3 text-center">Ú©Ø¯ Ø¨Ø±Ø´</th>
                            <th class="p-3 text-center">ØªØ¹Ø¯Ø§Ø¯</th>
                            <th class="p-3 text-center">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·</th>
                            <th class="p-3">ØªØ®ØµÛŒØµ Ø¨Ù‡ (Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´)</th>
                            <th class="p-3 text-center">Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)</th>
                            <th class="p-3">ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</th>
                        </tr>
                    </thead>
                    <tbody id="preview-table-body"></tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button onclick="closePreviewModal()" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg transition font-medium">Ø§Ù†ØµØ±Ø§Ù</button>
                <button onclick="confirmDistribution()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-lg transition flex items-center gap-2">
                    <span>ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ ØµØ¯ÙˆØ± Ø­ÙˆØ§Ù„Ù‡</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="edit-history-modal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center p-4 z-50 no-print backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl max-w-md w-full shadow-2xl">
            <h3 class="text-lg font-bold text-slate-900 mb-4 border-b border-slate-100 pb-4">ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ú©ÙˆØ±Ø¯</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Ù…Ø­ØµÙˆÙ„</span>
                    <p id="edit-product-name" class="font-bold text-slate-800 text-lg mt-1"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ØªØ¹Ø¯Ø§Ø¯ (ØªÙˆÙ„ÛŒØ¯):</label>
                        <input type="number" id="edit-items-count" class="input-style bg-blue-50 border-blue-200 font-bold text-blue-700" min="1">
                        <p class="text-[10px] text-slate-400 mt-1">Ø²Ù…Ø§Ù† Ùˆ Ø®Ø· Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
                    </div>
                    <div>
                         <label class="block text-sm font-bold text-slate-700 mb-2">ØªØºÛŒÛŒØ± Ù…Ø³Ø¦ÙˆÙ„:</label>
                         <p id="edit-current-worker" class="text-xs text-red-500 mb-1 hidden"></p>
                         <select id="edit-new-worker-select" class="input-style bg-slate-50">
                            </select>
                    </div>
                </div>
            </div>
            
            <input type="hidden" id="edit-assignment-id">

            <div class="flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button onclick="document.getElementById('edit-history-modal').classList.add('hidden'); document.getElementById('edit-history-modal').classList.remove('flex');" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">Ø§Ù†ØµØ±Ø§Ù</button>
                <button onclick="saveEditedAssignment()" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow transition">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-50 no-print backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl max-w-sm w-full text-center shadow-xl">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-lg font-bold text-slate-900 mb-2">Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</h3>
            <p id="alert-msg" class="text-sm text-slate-600 mb-6"></p>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="w-full btn-primary bg-slate-800 hover:bg-slate-900">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
        </div>
    </div>

    <script>
        // --- INDEXED DB ENGINE ---
        const DB_NAME = 'SmartCutDB';
        const DB_VERSION = 1;
        let db;

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject("Database error: " + event.target.errorCode);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('workers')) db.createObjectStore('workers', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('assignments')) db.createObjectStore('assignments', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('productTemplates')) db.createObjectStore('productTemplates', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('systemInfo')) db.createObjectStore('systemInfo', { keyPath: 'key' });
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
            });
        }

        async function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbPut(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(item);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        async function dbDelete(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function dbClear(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // --- Data ---
        let workers = [];
        let assignments = [];
        let productTemplates = [];
        let currentTasks = [];
        let pendingAssignments = []; 
        let absentWorkerIds = new Set();
        let justiceChart = null; 
        let historyPage = 1;
        const historyPerPage = 10;

        const LEVEL_WEIGHTS = { 'Ù‚ÙˆÛŒ': 1.3, 'Ù…ØªÙˆØ³Ø·': 1.0, 'Ø¶Ø¹ÛŒÙ': 0.8 };

        window.onload = async function() {
            await openDB(); 
            
            await loadData();
            renderAll();
            setupEventListeners();
            updateUIState();
            document.getElementById('print-date').innerText = new Date().toLocaleDateString('fa-IR');
            initChart();
            updateChartData();
            populateHistoryFilters();
        };

        // Removed migrateFromLocalStorage function

        function renderAll() {
            renderWorkersList(); 
            renderWorkersManagement(); 
            renderProductTemplates(); 
            renderProductSelect(); 
            renderCurrentTasks(); 
        }

        function switchTab(tabName) {
            ['dashboard', 'settings', 'history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden-tab');
                document.getElementById(`tab-btn-${t}`).classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden-tab');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            if (tabName === 'history') { 
                populateHistoryFilters();
                historyPage = 1; 
                renderHistory(); 
            }
        }

        window.handleEnter = function(event, callbackName) {
            if (event.key === 'Enter' && typeof window[callbackName] === 'function') window[callbackName]();
        }

        function validateInput(id) {
            const el = document.getElementById(id);
            if (!el) return false; 
            if (!el.value || el.value.trim() === '') {
                el.classList.add('input-error');
                el.addEventListener('input', function() { if(this.value.trim() !== '') this.classList.remove('input-error'); }, {once:true});
                return false;
            }
            el.classList.remove('input-error');
            return true;
        }

        async function loadData() {
            try {
                workers = await dbGetAll('workers');
                assignments = await dbGetAll('assignments');
                productTemplates = await dbGetAll('productTemplates');
                calculateMonthlyStats();
            } catch (e) { console.error(e); }
        }

        async function saveData() {
             const saveToStore = (storeName, items) => {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([storeName], 'readwrite');
                    const store = tx.objectStore(storeName);
                    
                    // Clear existing
                    store.clear();
                    
                    // Add new
                    items.forEach(item => store.put(item));
                    
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                });
            };

            try {
                await Promise.all([
                    saveToStore('workers', workers),
                    saveToStore('assignments', assignments),
                    saveToStore('productTemplates', productTemplates)
                ]);
            } catch (error) {
                console.error("Save Data Error:", error);
            }
        }

        async function clearAllData() {
            if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.")) { 
                await dbClear('workers');
                await dbClear('assignments');
                await dbClear('productTemplates');
                location.reload(); 
            }
        }

        function calculateMonthlyStats() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            workers.forEach(w => { 
                w.monthlyTime = 0; 
                w.monthlyLines = 0; 
                w.monthlyTaskCount = 0; 
                w.lastTask = null; 
            });
            
            const sorted = [...assignments].sort((a,b) => a.cutDate - b.cutDate);
            sorted.forEach(t => {
                const w = workers.find(x => x.id === t.workerId);
                if(w) {
                    w.lastTask = { product: t.product, size: t.size, date: t.cutDate };
                    if(t.cutDate >= startOfMonth) {
                        w.monthlyTime += (t.standardTimeTotal || 0);
                        w.monthlyLines += (t.totalLines || 0); 
                        w.monthlyTaskCount++;
                    }
                }
            });
            updateChartData();
        }

        function initChart() {
            const ctx = document.getElementById('justiceChart').getContext('2d');
            justiceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
            });
        }
        function updateChartData() {
            if(!justiceChart) return;
            const labels = workers.map(w => w.name);
            const data = workers.map(w => w.monthlyTime);
            justiceChart.data.labels = labels;
            justiceChart.data.datasets[0].data = data;
            justiceChart.update();
        }

        function addWorker() {
            if(!validateInput('worker-name')) return showAlert("Ù†Ø§Ù… Ù¾Ø±Ø³Ù†Ù„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
            const name = document.getElementById('worker-name').value.trim();
            const level = document.getElementById('worker-level').value;
            workers.push({ id: 'w_'+Date.now(), name, level, monthlyTime: 0, monthlyLines:0, monthlyTaskCount: 0 });
            saveData(); renderAll(); updateUIState();
            document.getElementById('worker-name').value = '';
        }
        function toggleAttendance(id) {
            absentWorkerIds.has(id) ? absentWorkerIds.delete(id) : absentWorkerIds.add(id);
            renderWorkersList(); updateUIState();
        }
        function renderWorkersList() {
            const container = document.getElementById('worker-list-container');
            container.innerHTML = '';
            ['Ù‚ÙˆÛŒ','Ù…ØªÙˆØ³Ø·','Ø¶Ø¹ÛŒÙ'].forEach(level => {
                const group = workers.filter(w => w.level === level);
                if(group.length) {
                    group.sort((a,b) => a.monthlyTime - b.monthlyTime);
                    const div = document.createElement('div');
                    div.innerHTML = `<h5 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-4 flex justify-between px-1"><span>${level}</span><span class="text-[10px]">Ø´Ø§Ø®Øµ: ØªØ¹Ø§Ø¯Ù„ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ</span></h5>`;
                    group.forEach(w => {
                        const isAbsent = absentWorkerIds.has(w.id);
                        div.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded-lg text-sm border-l-4 transition-all ${isAbsent ? 'bg-slate-100 opacity-60' : 'bg-white shadow-sm hover:shadow-md'} ${level==='Ù‚ÙˆÛŒ'?'border-green-500':level==='Ù…ØªÙˆØ³Ø·'?'border-yellow-500':'border-red-500'}">
                            <div class="flex gap-3 items-center">
                                <input type="checkbox" ${!isAbsent?'checked':''} onchange="toggleAttendance('${w.id}')" class="cursor-pointer w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                                <div>
                                    <div class="font-bold text-slate-800 ${isAbsent?'line-through':''}">${w.name}</div>
                                    <div class="text-[10px] text-slate-500">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·: ${w.monthlyLines.toLocaleString()}</div>
                                </div>
                            </div>
                            <span class="font-mono text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded text-xs">${w.monthlyTime.toFixed(0)} <span class="text-[10px] text-slate-400 font-sans">Ø¯Ù‚ÛŒÙ‚Ù‡</span></span>
                        </div>`;
                    });
                    container.appendChild(div);
                }
            });
        }
        function renderWorkersManagement() {
            document.getElementById('workers-management-body').innerHTML = workers.map(w => `<tr><td>${w.name}</td><td class="text-center">${w.level}</td><td class="text-center"><button onclick="deleteWorker('${w.id}')" class="text-red-500 text-xs hover:bg-red-50 px-2 py-1 rounded">Ø­Ø°Ù</button></td></tr>`).join('');
        }
        function deleteWorker(id) { if(confirm('Ø­Ø°ÙØŸ')) { workers = workers.filter(w=>w.id!==id); saveData(); renderAll(); updateUIState(); } }

        function addProductTemplate() {
            const nameValid = validateInput('tpl-product-name');
            const timeValid = validateInput('tpl-std-time');
            if(!nameValid || !timeValid) return showAlert("Ù†Ø§Ù… Ùˆ Ø²Ù…Ø§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
            
            const groupEl = document.getElementById('tpl-group');
            const group = groupEl ? groupEl.value.trim() : '';
            const nameEl = document.getElementById('tpl-product-name');
            const name = nameEl ? nameEl.value.trim() : '';
            const designEl = document.getElementById('tpl-design');
            const design = designEl ? designEl.value.trim() : '';
            const linesEl = document.getElementById('tpl-lines');
            const lines = linesEl ? (parseInt(linesEl.value) || 0) : 0;
            const timeEl = document.getElementById('tpl-std-time');
            const time = timeEl ? parseFloat(timeEl.value) : 0;
            
            productTemplates.push({id: Date.now(), group, name, design, lines, stdTime: time});
            saveData(); renderProductTemplates(); renderProductSelect();
            
            if(nameEl) nameEl.value = '';
            if(designEl) designEl.value = '';
            if(linesEl) linesEl.value = '';
            if(timeEl) timeEl.value = '';
        }
        function renderProductTemplates() {
            document.getElementById('product-templates-body').innerHTML = productTemplates.map(p => `<tr><td>${p.group||'-'}</td><td>${p.name}</td><td>${p.design||'-'}</td><td class="text-center">${p.lines||0}</td><td class="text-center font-mono">${p.stdTime}</td><td class="text-center"><button onclick="deleteProduct(${p.id})" class="text-red-500 text-xs hover:bg-red-50 px-2 py-1 rounded">Ø­Ø°Ù</button></td></tr>`).join('');
        }
        
// Ù…ØªØºÛŒØ± Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†Ù…ÙˆÙ†Ù‡ TomSelect
let productSelectInstance = null;

function renderProductSelect() {
    const select = document.getElementById('quick-product-select');
    
    // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ØŒ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù† ØªØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø³Ø§Ø²ÛŒÙ…
    if (productSelectInstance) {
        productSelectInstance.destroy();
        productSelectInstance = null;
    }

    // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ HTML Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
    select.innerHTML = '<option value="">-- ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';
    const groups = {};
    
    productTemplates.forEach(p => {
        const g = p.group || "Ø³Ø§ÛŒØ±";
        if(!groups[g]) groups[g] = [];
        groups[g].push(p);
    });

    Object.keys(groups).sort().forEach(gName => {
        const groupEl = document.createElement('optgroup');
        groupEl.label = gName;
        groups[gName].forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            // Ù…ØªÙ†ÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø³ØªØ¬Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            opt.text = `${p.name} ${p.design ? '('+p.design+')' : ''}`;
            // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù„ÛŒØ³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            opt.setAttribute('data-time', p.stdTime);
            groupEl.appendChild(opt);
        });
        select.appendChild(groupEl);
    });

    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¬Ø³ØªØ¬Ùˆ Ø±ÙˆÛŒ Ø§Ù„Ù…Ù†Øª
    productSelectInstance = new TomSelect('#quick-product-select', {
        create: false, // Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ù‡Ø¯ Ú©Ø§Ø±Ø¨Ø± Ú†ÛŒØ²ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù„ÛŒØ³Øª ØªØ§ÛŒÙ¾ Ú©Ù†Ø¯
        sortField: { field: "text", direction: "asc" },
        placeholder: "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„...",
        direction: 'rtl', // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾
        onItemAdd: function() {
            // ÙˆÙ‚ØªÛŒ Ø¢ÛŒØªÙ…ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ØŒ ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø´Ù…Ø§ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
            applyProductTemplate();
        },
        onClear: function() {
            // ÙˆÙ‚ØªÛŒ Ù¾Ø§Ú© Ø´Ø¯ØŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ø´ÙˆÙ†Ø¯
            applyProductTemplate(); 
        }
    });
}
        function applyProductTemplate() {
            const p = productTemplates.find(x => x.id == document.getElementById('quick-product-select').value);
            if(p) {
                const fullName = p.design ? `${p.name} - ${p.design}` : p.name;
                document.getElementById('task-product').value = fullName;
                document.getElementById('task-std-time').value = p.stdTime;
                document.getElementById('task-lines').value = p.lines || 0;
                document.getElementById('display-lines').innerText = p.lines || 0;
                document.getElementById('display-design').innerText = p.design || '-';
            } else {
                document.getElementById('display-lines').innerText = '-';
                document.getElementById('display-design').innerText = '-';
            }
        }
        function deleteProduct(id) { productTemplates = productTemplates.filter(p=>p.id!==id); saveData(); renderProductTemplates(); renderProductSelect(); }

        function addTask() {
            if (!validateInput('task-product') || !validateInput('task-size') || !validateInput('task-series-count') || !validateInput('task-items-per-series') || !validateInput('task-std-time')) {
                return showAlert("Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");
            }

            const p = document.getElementById('task-product').value;
            const cutCode = document.getElementById('task-cut-code').value.trim(); // Get cut code
            const s = document.getElementById('task-size').value;
            const seriesCount = parseFloat(document.getElementById('task-series-count').value);
            const itemsPerSeries = parseInt(document.getElementById('task-items-per-series').value);
            const stdTimePerUnit = parseFloat(document.getElementById('task-std-time').value);
            const lineCountPerItem = parseInt(document.getElementById('task-lines').value) || 0;

            const totalItems = Math.ceil(seriesCount * itemsPerSeries);
            const totalTime = (seriesCount * itemsPerSeries * stdTimePerUnit) / 60;

            currentTasks.push({ 
                id: 't_'+Date.now(), 
                product: p, 
                cutCode: cutCode,
                size: s, 
                seriesCount: seriesCount,
                itemsPerSeries: itemsPerSeries,
                stdTimePerUnit: stdTimePerUnit,
                lineCountPerItem: lineCountPerItem,
                totalItems: totalItems,
                totalTime: totalTime
            });

            renderCurrentTasks(); updateUIState();
            document.getElementById('task-size').value = '';
            document.getElementById('task-series-count').value = '';
        }
        function removeTask(id) { currentTasks = currentTasks.filter(t=>t.id!==id); renderCurrentTasks(); updateUIState(); }
        function renderCurrentTasks() {
            const b = document.getElementById('current-tasks-body');
            b.innerHTML = '';
            if(!currentTasks.length) { document.getElementById('current-tasks-container').classList.add('hidden'); return; }
            document.getElementById('current-tasks-container').classList.remove('hidden');
            currentTasks.forEach(t => {
                b.innerHTML += `<tr><td class="text-xs font-mono text-slate-500">${t.cutCode || '-'}</td><td class="font-bold">${t.product}</td><td class="text-center bg-slate-50">${t.size}</td><td class="text-center font-bold">${t.seriesCount}</td><td class="text-center text-slate-500">${t.totalItems}</td><td class="text-center font-mono text-blue-600">${t.totalTime.toFixed(1)}</td><td class="text-center"><button onclick="removeTask('${t.id}')" class="text-red-500 text-xs hover:bg-red-50 px-2 py-1 rounded">Ø­Ø°Ù</button></td></tr>`;
            });
        }

        function distributeTasks() {
            const presentWorkers = workers.filter(w => !absentWorkerIds.has(w.id));
            if(!presentWorkers.length || !currentTasks.length) return showAlert("Ù†ÛŒØ±Ùˆ ÛŒØ§ Ú©Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯");

            let explodedTasks = [];
            currentTasks.forEach(task => {
                const fullSeries = Math.floor(task.seriesCount);
                const remainder = task.seriesCount - fullSeries;

                for(let i=0; i < fullSeries; i++) {
                    const timeInMin = (task.itemsPerSeries * task.stdTimePerUnit) / 60;
                    explodedTasks.push({
                        ...task,
                        batchId: `${task.id}_full_${i}`,
                        parentTaskId: task.id,
                        actualItems: task.itemsPerSeries,
                        actualTime: timeInMin,
                        actualLines: task.itemsPerSeries * task.lineCountPerItem,
                        desc: `Û± Ø³Ø±ÛŒ`
                    });
                }
                if(remainder > 0) {
                    const partialItems = Math.ceil(task.itemsPerSeries * remainder);
                    const partialTimeInMin = (partialItems * task.stdTimePerUnit) / 60;
                    explodedTasks.push({
                        ...task,
                        batchId: `${task.id}_part`,
                        parentTaskId: task.id,
                        actualItems: partialItems,
                        actualTime: partialTimeInMin,
                        actualLines: partialItems * task.lineCountPerItem,
                        desc: `${remainder} Ø³Ø±ÛŒ`
                    });
                }
            });

            explodedTasks.sort((a,b) => b.actualTime - a.actualTime);

            let workerStatus = presentWorkers.map(w => ({ ...w, tempTime: 0, tempLines: 0 }));
            pendingAssignments = [];

            explodedTasks.forEach(task => {
                let best = null;
                let minProjectedLoad = Infinity;

                workerStatus.forEach(cand => {
                    const projectedTime = cand.monthlyTime + cand.tempTime + task.actualTime;
                    const weight = LEVEL_WEIGHTS[cand.level] || 1.0;
                    let adjustedLoadScore = projectedTime / weight;

                    let penalty = 0;
                    const hasChunkOfSameTask = pendingAssignments.some(p => p.workerId === cand.id && p.parentTaskId === task.parentTaskId);
                    if (hasChunkOfSameTask) penalty += 1000000;
                    if (cand.lastTask && cand.lastTask.product === task.product) penalty += 5000; 

                    let finalScore = adjustedLoadScore + penalty;
                    if (finalScore < minProjectedLoad) {
                        minProjectedLoad = finalScore;
                        best = cand;
                    }
                });

                if (best) {
                    best.tempTime += task.actualTime;
                    best.tempLines += task.actualLines;
                    let note = "";
                    if (best.lastTask && best.lastTask.product === task.product) note = "ØªÚ©Ø±Ø§Ø± Ù…Ø­ØµÙˆÙ„";
                    
                    pendingAssignments.push({
                        ...task,
                        id: 'asg_' + Math.random().toString(36).substr(2, 9),
                        workerId: best.id,
                        workerName: best.name,
                        level: best.level,
                        standardTimeTotal: task.actualTime,
                        totalLines: task.actualLines,
                        itemsCount: task.actualItems,
                        cutDate: Date.now(),
                        warning: note,
                        // Persist task specific params for future edits
                        stdTimePerUnit: task.stdTimePerUnit, 
                        lineCountPerItem: task.lineCountPerItem,
                        cutCode: task.cutCode
                    });
                }
            });
            openPreviewModal();
        }

        function openPreviewModal() {
            const tbody = document.getElementById('preview-table-body');
            tbody.innerHTML = '';
            const presentWorkers = workers.filter(w => !absentWorkerIds.has(w.id));
            
            pendingAssignments.forEach((p, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border-b p-3">
                        <div class="font-bold text-slate-800">${p.product}</div>
                        <div class="text-xs text-slate-500">Ø³Ø§ÛŒØ² ${p.size} (${p.desc})</div>
                    </td>
                    <td class="border-b p-3 text-center text-xs text-slate-400 font-mono">${p.cutCode || '-'}</td>
                    <td class="border-b p-3 text-center">${p.itemsCount}</td>
                    <td class="border-b p-3 text-center text-xs text-slate-500">${p.totalLines.toLocaleString()}</td>
                    <td class="border-b p-3">
                        <select class="input-style bg-yellow-50 font-bold text-slate-800 border-yellow-200" onchange="updatePendingWorker(${index}, this.value)">
                            ${presentWorkers.map(w => `<option value="${w.id}" ${w.id === p.workerId ? 'selected' : ''}>${w.name} (${w.level})</option>`).join('')}
                        </select>
                    </td>
                    <td class="border-b p-3 text-center font-mono">${p.standardTimeTotal.toFixed(1)}</td>
                    <td class="border-b p-3 text-xs text-orange-500">${p.warning || ''}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('preview-modal').classList.remove('hidden');
            document.getElementById('preview-modal').classList.add('flex');
        }

        function updatePendingWorker(index, newId) {
            const w = workers.find(x => x.id === newId);
            if(w) { pendingAssignments[index].workerId = w.id; pendingAssignments[index].workerName = w.name; pendingAssignments[index].level = w.level; }
        }
        function closePreviewModal() { document.getElementById('preview-modal').classList.add('hidden'); document.getElementById('preview-modal').classList.remove('flex'); }
        
        function confirmDistribution() {
            assignments = [...assignments, ...pendingAssignments];
            saveData(); calculateMonthlyStats();
            currentTasks = []; renderCurrentTasks(); renderWorkersList(); renderAssignmentTable(pendingAssignments);
            updateUIState(); closePreviewModal();
        }

        function renderAssignmentTable(results) {
            document.getElementById('assignment-results').classList.remove('hidden');
            const tbody = document.getElementById('assignment-table-body');
            tbody.innerHTML = '';
            const grouped = {};
            results.forEach(r => {
                if(!grouped[r.workerId]) grouped[r.workerId] = {name:r.workerName, level:r.level, tasks:[], totalT:0, totalL:0, totalI:0};
                grouped[r.workerId].tasks.push(r);
                grouped[r.workerId].totalT += r.standardTimeTotal;
                grouped[r.workerId].totalL += r.totalLines;
                grouped[r.workerId].totalI += r.itemsCount;
            });

            let grandTotal = 0;
            Object.values(grouped).forEach(g => {
                grandTotal += g.totalT;
                const tasksHtml = g.tasks.map(t => `<div class="border-b border-slate-100 last:border-0 mb-2 pb-2"><b>${t.product}</b> <span class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-600">Ø³Ø§ÛŒØ² ${t.size}</span> <span class="text-xs text-slate-400">(${t.cutCode || '-'})</span></div>`).join('');
                tbody.innerHTML += `
                <tr class="hover:bg-slate-50">
                    <td class="align-top">
                        <div class="font-bold text-slate-800">${g.name}</div>
                        <div class="text-xs text-slate-500 bg-slate-100 inline-block px-2 py-0.5 rounded mt-1">${g.level}</div>
                    </td>
                    <td class="align-top text-slate-600">${tasksHtml}</td>
                    <td class="align-top text-center text-lg font-bold">${g.totalI}</td>
                    <td class="align-top text-center font-mono text-slate-600 bg-slate-50 rounded">${g.totalL.toLocaleString()}</td>
                    <td class="align-top text-center text-lg font-bold text-blue-600">${g.totalT.toFixed(1)}</td>
                </tr>`;
            });
            document.getElementById('today-total-time').innerText = `Ù…Ø¬Ù…ÙˆØ¹ Ø²Ù…Ø§Ù†: ${grandTotal.toFixed(1)} Ø¯Ù‚ÛŒÙ‚Ù‡`;
            document.getElementById('assignment-results').scrollIntoView({behavior:'smooth'});
        }

        // --- Helper for Date Filtering ---
        function toEnglishDigits(str) {
            return str.replace(/[Û°-Û¹]/g, w => String.fromCharCode(w.charCodeAt(0) - 1728))
                      .replace(/[Ù -Ù©]/g, w => String.fromCharCode(w.charCodeAt(0) - 1584));
        }

        function resetHistoryFilters() {
            document.getElementById('history-search-q').value = '';
            document.getElementById('history-filter-worker').value = '';
            document.getElementById('history-filter-date-from').value = '';
            document.getElementById('history-filter-date-to').value = '';
            renderHistory();
        }

        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            
            let filtered = [...assignments];

            // Filter Logic
            const filterWorker = document.getElementById('history-filter-worker').value.trim();
            const filterDateFrom = document.getElementById('history-filter-date-from').value.trim();
            const filterDateTo = document.getElementById('history-filter-date-to').value.trim();
            const searchQ = document.getElementById('history-search-q').value.trim().toLowerCase();

            if(filterWorker) {
                filtered = filtered.filter(a => a.workerId === filterWorker);
            }
            
            if (filterDateFrom) {
                 const normFrom = toEnglishDigits(filterDateFrom);
                 filtered = filtered.filter(a => {
                     const d = new Date(a.cutDate).toLocaleDateString('fa-IR');
                     return toEnglishDigits(d) >= normFrom;
                 });
            }
            if (filterDateTo) {
                 const normTo = toEnglishDigits(filterDateTo);
                 filtered = filtered.filter(a => {
                     const d = new Date(a.cutDate).toLocaleDateString('fa-IR');
                     return toEnglishDigits(d) <= normTo;
                 });
            }

            if(searchQ) {
                filtered = filtered.filter(a => 
                    a.workerName.toLowerCase().includes(searchQ) || 
                    a.product.toLowerCase().includes(searchQ) ||
                    (a.cutCode && a.cutCode.toLowerCase().includes(searchQ))
                );
            }

            // --- New Summary Calculation ---
            const sumCount = filtered.reduce((s, a) => s + (a.itemsCount || 0), 0);
            const sumLines = filtered.reduce((s, a) => s + (a.totalLines || 0), 0);
            const sumTime = filtered.reduce((s, a) => s + (a.standardTimeTotal || 0), 0);
            
            document.getElementById('summary-total-items').innerText = sumCount.toLocaleString();
            document.getElementById('summary-total-lines').innerText = sumLines.toLocaleString();
            document.getElementById('summary-total-time').innerText = sumTime.toFixed(1);
            document.getElementById('history-summary').classList.remove('hidden');

            if(!filtered.length) {
                document.getElementById('no-history-msg').classList.remove('hidden');
                document.getElementById('history-pagination').style.display = 'none';
                return; 
            }
            document.getElementById('no-history-msg').classList.add('hidden');
            document.getElementById('history-pagination').style.display = 'flex';

            const sorted = filtered.sort((a,b) => b.cutDate - a.cutDate);
            const total = Math.ceil(sorted.length/historyPerPage);
            if(historyPage > total) historyPage = total || 1;
            const chunk = sorted.slice((historyPage-1)*historyPerPage, historyPage*historyPerPage);
            
            chunk.forEach(a => {
                const d = new Date(a.cutDate);
                if(!a.id) a.id = 'asg_' + Math.random().toString(36).substr(2, 9);
                
                tbody.innerHTML += `
                <tr class="hover:bg-slate-50 transition">
                    <td class="border-b py-3"><div class="font-bold">${d.toLocaleDateString('fa-IR')}</div><div class="text-xs text-slate-400">${d.toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'})}</div></td>
                    <td class="border-b font-bold text-slate-800">${a.workerName}</td>
                    <td class="border-b text-center text-xs font-mono text-slate-500">${a.cutCode || '-'}</td>
                    <td class="border-b">${a.product} <span class="bg-slate-100 px-1 rounded text-xs text-slate-500">${a.size}</span></td>
                    <td class="border-b text-center text-xs text-slate-500">${a.desc || '1 Ø³Ø±ÛŒ'}</td>
                    <td class="border-b text-center font-bold">${a.itemsCount||'-'}</td>
                    <td class="border-b text-center font-mono text-slate-600 bg-slate-50 rounded text-xs">${(a.totalLines || 0).toLocaleString()}</td>
                    <td class="border-b text-center font-mono text-blue-600 font-bold">${a.standardTimeTotal.toFixed(1)}</td>
                    <td class="border-b text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="editHistoryItem('${a.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded transition" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø³Ø¦ÙˆÙ„">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button onclick="deleteHistoryItem('${a.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Ø­Ø°Ù">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            document.getElementById('page-indicator').innerText = `ØµÙØ­Ù‡ ${historyPage} Ø§Ø² ${total}`;
            document.getElementById('prev-page-btn').disabled = historyPage <= 1;
            document.getElementById('next-page-btn').disabled = historyPage >= total;
        }
        
        function changeHistoryPage(d) { historyPage+=d; renderHistory(); }

        function populateHistoryFilters() {
             const select = document.getElementById('history-filter-worker');
             const currentVal = select.value;
             // Clear options except first
             select.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ù¾Ø±Ø³Ù†Ù„</option>';
             
             workers.forEach(w => {
                 const opt = document.createElement('option');
                 opt.value = w.id;
                 opt.text = w.name;
                 select.appendChild(opt);
             });
             select.value = currentVal;
        }

async function deleteHistoryItem(id) {
    if(confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) {
        // 1. Ø­Ø°Ù Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
        assignments = assignments.filter(a => a.id !== id);
        
        // 2. Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ø¨Ø§ await Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø°Ø®ÛŒØ±Ù‡)
        await saveData(); 
        
        // 3. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¢Ù…Ø§Ø±Ù‡Ø§
        calculateMonthlyStats(); 
        
        // 4. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø§ÛŒØ± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
        renderAll(); 
        
        // 5. *** Ø®Ø· Ù…Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„ Ú¯Ø²Ø§Ø±Ø´Ø§Øª ***
        renderHistory(); 
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        // showAlert("Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯");
    }
}
        function editHistoryItem(id) {
            const assignment = assignments.find(a => a.id === id);
            if(!assignment) return;
            document.getElementById('edit-assignment-id').value = id;
            document.getElementById('edit-product-name').innerText = `${assignment.product} (Ø³Ø§ÛŒØ² ${assignment.size}) - ${assignment.desc || ''}`;
            document.getElementById('edit-current-worker').innerText = assignment.workerName;
            document.getElementById('edit-items-count').value = assignment.itemsCount; // Load items count
            
            const select = document.getElementById('edit-new-worker-select');
            select.innerHTML = workers.map(w => `<option value="${w.id}" ${w.id === assignment.workerId ? 'selected' : ''}>${w.name} (${w.level})</option>`).join('');
            document.getElementById('edit-history-modal').classList.remove('hidden');
            document.getElementById('edit-history-modal').classList.add('flex');
        }

        function saveEditedAssignment() {
            const id = document.getElementById('edit-assignment-id').value;
            const newWorkerId = document.getElementById('edit-new-worker-select').value;
            const newCount = parseInt(document.getElementById('edit-items-count').value);

            const newWorker = workers.find(w => w.id === newWorkerId);
            
            if(newWorker && newCount > 0) {
                const index = assignments.findIndex(a => a.id === id);
                if(index !== -1) {
                    const task = assignments[index];
                    
                    // Recalculate Time & Lines based on new count
                    // Time = (Items * TimePerUnit) / 60
                    const perUnitTime = task.stdTimePerUnit || 0;
                    const perUnitLines = task.lineCountPerItem || 0;
                    
                    const newTotalTime = (newCount * perUnitTime) / 60;
                    const newTotalLines = newCount * perUnitLines;

                    assignments[index].workerId = newWorker.id;
                    assignments[index].workerName = newWorker.name;
                    assignments[index].level = newWorker.level;
                    assignments[index].itemsCount = newCount;
                    assignments[index].standardTimeTotal = newTotalTime;
                    assignments[index].totalLines = newTotalLines;
                    
                    saveData(); calculateMonthlyStats(); renderAll();
                    document.getElementById('edit-history-modal').classList.add('hidden');
                    showAlert("ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
                }
            } else {
                 showAlert("Ù„Ø·ÙØ§ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            }
        }

        function exportReportExcel() {
             let filtered = [...assignments];
             const filterWorker = document.getElementById('history-filter-worker').value.trim();
             const filterDateFrom = document.getElementById('history-filter-date-from').value.trim();
             const filterDateTo = document.getElementById('history-filter-date-to').value.trim();
             const searchQ = document.getElementById('history-search-q').value.trim().toLowerCase();

            if(filterWorker) {
                filtered = filtered.filter(a => a.workerId === filterWorker);
            }
            
            if (filterDateFrom) {
                 const normFrom = toEnglishDigits(filterDateFrom);
                 filtered = filtered.filter(a => {
                     const d = new Date(a.cutDate).toLocaleDateString('fa-IR');
                     return toEnglishDigits(d) >= normFrom;
                 });
            }
            if (filterDateTo) {
                 const normTo = toEnglishDigits(filterDateTo);
                 filtered = filtered.filter(a => {
                     const d = new Date(a.cutDate).toLocaleDateString('fa-IR');
                     return toEnglishDigits(d) <= normTo;
                 });
            }

            if(searchQ) {
                filtered = filtered.filter(a => 
                    a.workerName.toLowerCase().includes(searchQ) || 
                    a.product.toLowerCase().includes(searchQ) ||
                    (a.cutCode && a.cutCode.toLowerCase().includes(searchQ))
                );
            }
            
            if(!filtered.length) { showAlert("Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"); return; }

            // CSV Header
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM
            csvContent += "ØªØ§Ø±ÛŒØ®,Ú©Ø¯ Ø¨Ø±Ø´,Ù¾Ø±Ø³Ù†Ù„,Ø³Ø·Ø­,Ù…Ø­ØµÙˆÙ„,Ø³Ø§ÛŒØ²,ØªÙˆØ¶ÛŒØ­Ø§Øª,ØªØ¹Ø¯Ø§Ø¯,ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·,Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)\n";

            filtered.forEach(a => {
                const d = new Date(a.cutDate).toLocaleDateString('fa-IR');
                const row = [
                    d,
                    a.cutCode || '',
                    a.workerName,
                    a.level,
                    a.product,
                    a.size,
                    a.desc || '',
                    a.itemsCount,
                    a.totalLines || 0,
                    a.standardTimeTotal.toFixed(2)
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "smartcut_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportData() { const s = "data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({workers,assignments,productTemplates})); const a = document.createElement('a'); a.href=s; a.download="smartcut_backup.json"; a.click(); }
        function importData(inp) { const r=new FileReader(); r.onload=e=>{ const d=JSON.parse(e.target.result); workers=d.workers; assignments=d.assignments; productTemplates=d.productTemplates||[]; saveData(); location.reload(); }; if(inp.files[0]) r.readAsText(inp.files[0]); }

        function setupEventListeners() {
            document.getElementById('add-task-btn').addEventListener('click', addTask);
            document.getElementById('distribute-btn').addEventListener('click', distributeTasks);
        }
        function updateUIState() {
            const p = workers.filter(w=>!absentWorkerIds.has(w.id)).length > 0;
            const t = currentTasks.length > 0;
            document.getElementById('distribute-btn').disabled = !(p && t);
        }
        function updateDefaultLayers() {
            const val = document.getElementById('global-layers').value;
            if(val) document.getElementById('task-items-per-series').placeholder = `Ù…Ø«Ø§Ù„: ${val}`;
        }
        function showAlert(msg) { document.getElementById('alert-msg').textContent = msg; document.getElementById('alert-modal').classList.remove('hidden'); }
    </script>
</body>
</html>
